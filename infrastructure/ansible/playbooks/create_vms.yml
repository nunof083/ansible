---
- name: Provisioning des VMs Kubernetes sur Proxmox
  hosts: proxmox
  become: false

  vars_files:
    - "../vaults/secrets.yml"

  vars:
    proxmox_node: "870A43E"       # V√©rifie si ton n≈ìud s'appelle bien 'pve' dans l'interface
    template_id: 9000         # Ton template
    ssh_public_key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    # üìã La liste de tes machines √† cr√©er
    vms:
      - name: "k8s-master"
        vmid: 101
        cores: 2
        memory: 4096          # 4 Go
        ip: "10.10.10.20"
      
      - name: "k8s-worker-01"
        vmid: 102
        cores: 2
        memory: 6144          # 6 Go (App + DB)
        ip: "10.10.10.21"

      - name: "k8s-worker-02"
        vmid: 103
        cores: 2
        memory: 6144          # 6 Go (Backend + AWX)
        ip: "10.10.10.22"

  tasks:
    - name: "Cr√©ation des VMs depuis le template {{ template_id }}"
      community.general.proxmox_kvm:
        api_host: "10.10.10.1"
        api_user: "root@pam"
        api_password: "{{ proxmox_password }}" # ‚ö†Ô∏è Mets ton vrai mdp ici
        node: "{{ proxmox_node }}"
        name: "{{ item.name }}"
        vmid: "{{ item.vmid }}"
        clone: "{{ template_id }}"
        storage: local        # ‚úÖ Adapt√© √† ton stockage
        format: qcow2         # ‚úÖ qcow2 est mieux pour le stockage 'local'
        full: yes
        state: present
        timeout: 300          # On laisse du temps pour la copie
        
        # Hardware
        cores: "{{ item.cores }}"
        memory: "{{ item.memory }}"
        scsihw: virtio-scsi-pci
        
        # R√©seau Priv√©
        net:
          net0: "model=virtio,bridge=vmbr1"
        
        # Cloud-Init (C'est ici qu'on injecte ta cl√© SSH)
        ciuser: "debian"
        cipassword: "{{ user_password}}" # Mdp de secours pour l'utilisateur debian
        sshkeys: "{{ ssh_public_key }}"
        ipconfig:
          ipconfig0: "ip={{ item.ip }}/24,gw=10.10.10.1"
      
      # Dis au Ansible de faire tourner la t√¢che sur le localhost car module proxmoxer est sur le localhost
      delegate_to: localhost

      loop: "{{ vms }}"
      register: vm_creation

    - name: D√©marrer les VMs fra√Æchement cr√©√©es
      community.general.proxmox_kvm:
        api_host: "10.10.10.1"
        api_user: "root@pam"
        api_password: "{{ proxmox_password }}" # ‚ö†Ô∏è Le m√™me mdp
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started

      # Dis au Ansible de faire tourner la t√¢che sur le localhost car module proxmoxer est sur le localhost
      delegate_to: localhost

      loop: "{{ vms }}"
      when: vm_creation.changed