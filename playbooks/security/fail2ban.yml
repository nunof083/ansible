---
- name: Sécurisation du Serveur - Fail2ban
  hosts: pve-host
  become: yes
  vars:
    # ⚠️ Change ce port si tu veux (ex: 2222), mais n'oublie pas de l'ouvrir dans ton VPN/Firewall provider avant !
    ssh_port: 294
    # Mets ici ton utilisateur (ex: 'root' ou ton user sudo)
    admin_user: "root"

  tasks:
    - name: Mettre à jour le cache apt et les paquets
      apt:
        update_cache: yes
        upgrade: dist
      when: ansible_os_family == "Debian"

    - name: Installer les paquets de sécurité indispensables
      apt:
        name:
          - fail2ban
          - unattended-upgrades
          - apt-listchanges
        state: present

    - name: Copier la configuration par défaut de Fail2Ban
      copy:
        src: /etc/fail2ban/jail.conf
        dest: /etc/fail2ban/jail.local
        remote_src: yes
        force: no

    - name: Activer la protection SSH dans Fail2Ban
      blockinfile:
        path: /etc/fail2ban/jail.local
        block: |
          [sshd]
          enabled = true
          port = {{ ssh_port }}
          filter = sshd
          logpath = /var/log/auth.log
          maxretry = 3
          bantime = 3600
      notify: Restart Fail2Ban

  handlers:
    - name: Restart Fail2Ban
      service:
        name: fail2ban
        state: restarted
