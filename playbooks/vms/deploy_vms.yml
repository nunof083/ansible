---
- name: D√©ploiement Hybride (SSH + API) Kubernetes
  hosts: localhost
  gather_facts: false
  
  vars_files:
    - "../../vaults/secrets.yml"

  vars:
    proxmox_node: "870A43E"
    pve_host_ip: "10.10.10.1"
    pve_user: "root@pam"
    
    template_id: 9000
    ssh_key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
    storage_name: "local"

    # üõ†Ô∏è CONFIGURATION DES VMS
    k3s_vms:
      - name: "k3s-master"
        vmid: 101
        cores: 2
        memory: 6144
        ip: "10.10.10.20"
      - name: "k3s-worker-01"
        vmid: 102
        cores: 2
        memory: 8192
        ip: "10.10.10.21"
      - name: "k3s-worker-02"
        vmid: 103
        cores: 2
        memory: 8192
        ip: "10.10.10.22"

  tasks:
    # 1. V√âRIFICATION
    - name: "V√©rifier les VMs existantes"
      community.proxmox.proxmox_vm_info:
        api_host: "{{ pve_host_ip }}"
        api_user: "{{ pve_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: false
        node: "{{ proxmox_node }}"
      register: existing_vms_info

    - name: "Liste des VMIDs existants"
      set_fact:
        existing_vmid_list: "{{ existing_vms_info.proxmox_vms | map(attribute='vmid') | list }}"

    # 2. CR√âATION (CLONAGE)
    - name: "Clonage Brut via SSH (si VM absente)"
      shell: |
        ssh -o StrictHostKeyChecking=no root@{{ pve_host_ip }} \
        "qm clone {{ template_id }} {{ item.vmid }} --name {{ item.name }} --full 1 --storage {{ storage_name }} --format qcow2"
      loop: "{{ k3s_vms }}"
      when: item.vmid not in existing_vmid_list
      register: clone_output
      changed_when: clone_output.rc == 0

    # 3. AGRANDISSEMENT DISQUE (PROXMOX) [NOUVEAU]
    # On force le disque scsi0 √† 50G. 
    # Note : Cela ne fonctionne que si la taille actuelle est < 50G.
    - name: "Extension du disque dur virtuel √† 50G"
      shell: |
        ssh -o StrictHostKeyChecking=no root@{{ pve_host_ip }} \
        "qm resize {{ item.vmid }} scsi0 50G"
      loop: "{{ k3s_vms }}"
      register: resize_result
      # On ignore l'erreur si le disque fait d√©j√† 50G ou plus
      failed_when: 
        - resize_result.rc != 0 
        - "'size' not in resize_result.stderr"
      # On le fait m√™me si la VM existait d√©j√†, pour √™tre s√ªr
      ignore_errors: yes

    # 4. CONFIGURATION (CPU/RAM/IP)
    - name: "Configuration des Ressources & Cloud-Init"
      community.proxmox.proxmox_kvm:
        api_host: "{{ pve_host_ip }}"
        api_user: "{{ pve_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: false
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        
        # Hardware
        cores: "{{ item.cores }}"
        memory: "{{ item.memory }}"
        scsihw: virtio-scsi-pci
        net:
          net0: "model=virtio,bridge=vmbr1"
        
        # Cloud-Init
        ciuser: "debian"
        cipassword: "{{ user_password }}"
        sshkeys: "{{ ssh_key }}"
        ipconfig:
          ipconfig0: "ip={{ item.ip }}/24,gw=10.10.10.1"
          
        state: present
        update: true
      loop: "{{ k3s_vms }}"

    # 5. D√âMARRAGE
    - name: "D√©marrage des VMs"
      community.proxmox.proxmox_kvm:
        api_host: "{{ pve_host_ip }}"
        api_user: "{{ pve_user }}"
        api_password: "{{ proxmox_password }}"
        validate_certs: false
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ k3s_vms }}"

    # 6. ATTENTE SSH (Important pour le Play suivant)
    - name: "Attendre que le SSH soit disponible sur les VMs"
      wait_for:
        port: 22
        host: "{{ item.ip }}"
        search_regex: OpenSSH
        delay: 10
        timeout: 300
      loop: "{{ k3s_vms }}"
